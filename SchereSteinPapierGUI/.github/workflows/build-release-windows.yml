name: Build & Release Windows Installer

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      bundle_javafx:
        description: 'Set to true to bundle JavaFX (downloads OpenJFX SDK)'
        required: false
        default: 'false'

jobs:
  build-and-package:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build with Maven (package fat JAR)
        run: mvn -B -DskipTests package

      - name: Locate built JAR and prepare dist
        shell: pwsh
        run: |
          Write-Host "Listing target folder"
          Get-ChildItem -Path target -File -Recurse | ForEach-Object { Write-Host $_.FullName }
          $jar = Get-ChildItem -Path target -Filter '*-shaded.jar' -Recurse -File | Select-Object -First 1
          if (-not $jar) {
            $jar = Get-ChildItem -Path target -Filter '*.jar' -Recurse -File | Where-Object { $_.Name -notlike '*original*' } | Select-Object -First 1
          }
          if (-not $jar) { Write-Error "No JAR found in target/"; exit 1 }
          Write-Host "Found JAR: $($jar.FullName)"
          if (-not (Test-Path dist)) { New-Item -ItemType Directory -Path dist | Out-Null }
          Copy-Item $jar.FullName -Destination (Join-Path $PWD 'dist' 'SchereSteinPapier.jar') -Force

      - name: Run packaging (Windows EXE only)
        shell: pwsh
        env:
          SIGN_PFX_B64: ${{ secrets.SIGN_PFX_B64 }}
          SIGN_PFX_PASSWORD: ${{ secrets.SIGN_PFX_PASSWORD }}
          SIGN_PFX_PATH: ${{ secrets.SIGN_PFX_PATH }}
        run: |
          $bundle = $false
          if ($Env:GITHUB_REF_TYPE -eq 'tag') { $bundle = $true }
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch' -and ${{ github.event.inputs.bundle_javafx }} -eq 'true') { $bundle = $true }
          if ($bundle) {
            Write-Host "Packaging with JavaFX bundling (tag or manual request)"
            powershell -ExecutionPolicy Bypass -File .\scripts\package-windows-only.ps1 -BundleJavaFX -JavaFXVersion '21' -IconPath ".\resources\favicon.ico"
          } else {
            Write-Host "Packaging without JavaFX bundling"
            powershell -ExecutionPolicy Bypass -File .\scripts\package-windows-only.ps1 -IconPath ".\resources\favicon.ico"
          }

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: installer/**

  create-release:
    needs: build-and-package
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download installer artifact
        uses: actions/download-artifact@v3
        with:
          name: installer

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          files: 'installer/**'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
